"use strict";(self.webpackChunksubsquid_docs=self.webpackChunksubsquid_docs||[]).push([[6517],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||p[h]||a;return n?r.createElement(m,o(o({ref:t},u),{},{components:n})):r.createElement(m,o({ref:t},u))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<a;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1802:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return p}});var r=n(87462),i=n(63366),a=(n(67294),n(3905)),o=["components"],s={description:"Quick how-to on running an Archive for a specific blockchain."},l="How to launch an Archive",c={unversionedId:"recipes/how-to-launch-a-squid-archive",id:"recipes/how-to-launch-a-squid-archive",title:"How to launch an Archive",description:"Quick how-to on running an Archive for a specific blockchain.",source:"@site/docs/recipes/how-to-launch-a-squid-archive.md",sourceDirName:"recipes",slug:"/recipes/how-to-launch-a-squid-archive",permalink:"/docs/recipes/how-to-launch-a-squid-archive",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/recipes/how-to-launch-a-squid-archive.md",tags:[],version:"current",frontMatter:{description:"Quick how-to on running an Archive for a specific blockchain."},sidebar:"tutorialSidebar",previous:{title:"Queries",permalink:"/docs/recipes/giant-squid-api/queries"},next:{title:"Migrate to v5",permalink:"/docs/recipes/migrate-to-v5"}},u={},p=[{value:"Overview",id:"overview",level:2},{value:"Requirements",id:"requirements",level:3},{value:"Squid Archive repository",id:"squid-archive-repository",level:2},{value:"Launch the Archive locally",id:"launch-the-archive-locally",level:3},{value:"Use local Archive in a Squid API",id:"use-local-archive-in-a-squid-api",level:3},{value:"Running in production environment",id:"running-in-production-environment",level:3},{value:"Caveats for \ud83c\udf4f M1 Macs",id:"caveats-for--m1-macs",level:2},{value:"Launch an Archive for a new blockchain",id:"launch-an-archive-for-a-new-blockchain",level:2},{value:"Launch Archives for EVM-compatible blockchain",id:"launch-archives-for-evm-compatible-blockchain",level:3}],d={toc:p};function h(e){var t=e.components,s=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"how-to-launch-an-archive"},"How to launch an Archive"),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"This quick Recipe covers how to launch an Archive for a blockchain that is already covered by Subsquid and how to run one for a new blockchain."),(0,a.kt)("h3",{id:"requirements"},"Requirements"),(0,a.kt)("p",null,"In order to run an Archive, it is required to have Docker installed. For a quick installation guide, head over to ",(0,a.kt)("a",{parentName:"p",href:"/docs/tutorial/development-environment-set-up#docker"},"the dedicated page"),"."),(0,a.kt)("h2",{id:"squid-archive-repository"},"Squid Archive repository"),(0,a.kt)("p",null,"Launching an Archive is as easy as visiting our ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid-archive-setup"},"dedicated Archive setup repository")," and checking if the blockchain you want to synchronize is listed. Let's say Equilibrium, in the context of this example."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Archives list in the repository",src:n(54552).Z,width:"1348",height:"598"})),(0,a.kt)("p",null,"If that is the case, simply clone the repository"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git clone git@github.com:subsquid/squid-archive-setup.git\n")),(0,a.kt)("h3",{id:"launch-the-archive-locally"},"Launch the Archive locally"),(0,a.kt)("p",null,"Navigate to the corresponding folder in a command line console window and run"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"docker-compose up -d\n")),(0,a.kt)("p",null,'{% hint style="info" %}\nThe -d parameter is advised to avoid locking the console window and being flooded by log messages.\n{% endhint %}'),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"This is what launching an Archive locally should look like",src:n(82782).Z,width:"2017",height:"418"})),(0,a.kt)("p",null,"To check that everything went well and verify the ports, launch the following command"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker container ls\n")),(0,a.kt)("p",null,"The result should look like this (you could have more entries, if you launched other containers in a separate context):"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"List of running containers, their names, and ports",src:n(26550).Z,width:"2488",height:"357"})),(0,a.kt)("p",null,"Now the last check to perform is visit the console, by typing this URL ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:4010/console")," in a browser."),(0,a.kt)("h3",{id:"use-local-archive-in-a-squid-api"},"Use local Archive in a Squid API"),(0,a.kt)("p",null,"In order for a Squid API to use the Archive we just launched locally, it is necessary to change the values in the ",(0,a.kt)("inlineCode",{parentName:"p"},"setDataSource")," function call, typically in the ",(0,a.kt)("inlineCode",{parentName:"p"},"processor.ts")," file (if the project was not differently customized). The ",(0,a.kt)("inlineCode",{parentName:"p"},"archive")," value should be set to ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:4010/v1/graphql"),":"),(0,a.kt)("p",null,'{% code title="processor.ts" %}'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'// ...\n\nprocessor.setDataSource({\n  archive: "http://localhost:4010/v1/graphql",\n  chain: "<insert chain WSS URL here>",\n});\n\n// ...\n')),(0,a.kt)("p",null,"{% endcode %}"),(0,a.kt)("h3",{id:"running-in-production-environment"},"Running in production environment"),(0,a.kt)("p",null,"The provided docker compose setup is a minimal configuration best suitable for dev and testing environments. For a stable production deployment we recommend the following."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Use a private gRPC endpoint (",(0,a.kt)("inlineCode",{parentName:"li"},"WS_PROVIDER_ENDPOINT_URI")," env variable in the docker file)"),(0,a.kt)("li",{parentName:"ul"},"Use managed Postgres database with non-root access (",(0,a.kt)("inlineCode",{parentName:"li"},"DB_*")," env variables in the docker file)"),(0,a.kt)("li",{parentName:"ul"},"Collect and monitor ",(0,a.kt)("a",{parentName:"li",href:"https://prometheus.io/"},"Prometheus")," metrics exposed at port 9090"),(0,a.kt)("li",{parentName:"ul"},"Increase ",(0,a.kt)("inlineCode",{parentName:"li"},"WORKERS_NUMBER")," environment variable to speed up the syncing. Usually somewhere between 5-50 workers is a sweet spot depending on the gRPC endpoint capacity.")),(0,a.kt)("p",null,"To reliably run an Archive we recommend 16GB RAM and modern CPU. Database storage requirements depend on the size of the network. A rule of thumb is to reserve around 100 kb per block, so e.g. for Kusama with ","~","10M blocks one needs about 1Tb for Postgres storage."),(0,a.kt)("h2",{id:"caveats-for--m1-macs"},"Caveats for \ud83c\udf4f M1 Macs"),(0,a.kt)("p",null,"A ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid/issues/21"},"known issue")," prevents M1 Macs from running the console. Possible workaround:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/subsquid/hydra"},"Clone subsquid/hydra repo")),(0,a.kt)("li",{parentName:"ol"},"checkout v5 branch"),(0,a.kt)("li",{parentName:"ol"},"build the gateway image with:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"./scripts/docker-build.sh --target indexer-gateway -t subsquid/hydra-indexer-gateway:5\n")),(0,a.kt)("p",null,"After that, you can run docker-compose as usual."),(0,a.kt)("h2",{id:"launch-an-archive-for-a-new-blockchain"},"Launch an Archive for a new blockchain"),(0,a.kt)("p",null,"If a specific blockchain is not listed in the repository, it is possible to add it by contributing to the repository itself, following these steps:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Fork the repository"),(0,a.kt)("li",{parentName:"ol"},"Create a folder dedicated to the new blockchain"),(0,a.kt)("li",{parentName:"ol"},"Copy one of the ",(0,a.kt)("inlineCode",{parentName:"li"},"docker-compose.yml")," file from another folder"," ",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Edit the ",(0,a.kt)("inlineCode",{parentName:"li"},"WS_PROVIDER_ENDPOINT_URI")," environment variable to the correct endpoint for the given chain"),(0,a.kt)("li",{parentName:"ul"},"Make sure to create a types bundle file named as the one mentioned in the ",(0,a.kt)("inlineCode",{parentName:"li"},"BUNDLE_TYPES")," environment variable (see next point)"))),(0,a.kt)("li",{parentName:"ol"},"The Archive needs to know which types the blockchain Runtime is using, and to instruct it, a types bundle JSON file needs to be passed in.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"To know how to create such a file for a given chain, head over to ",(0,a.kt)("a",{parentName:"li",href:"/docs/faq/where-do-i-get-a-type-bundle-for-my-chain"},"our dedicated page")))),(0,a.kt)("li",{parentName:"ol"},"Create a pull-request towards the main repository")),(0,a.kt)("h3",{id:"launch-archives-for-evm-compatible-blockchain"},"Launch Archives for EVM-compatible blockchain"),(0,a.kt)("p",null,"In the case of an EVM-compatible blockchain, you'd want to fully leverage the native support for EVM logs to process contracts, by making sure that the Archive is extracting that data from the blockchain itself."),(0,a.kt)("p",null,"To do so, simply follow the procedure above, but make sure to check that the images for the ",(0,a.kt)("inlineCode",{parentName:"p"},"indexer")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"indexer-gateway")," are, respectively:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"subsquid/hydra-evm-indexer:5")),(0,a.kt)("li",{parentName:"ul"}," ",(0,a.kt)("inlineCode",{parentName:"li"},"subsquid/hydra-evm-indexer-gateway:5"))),(0,a.kt)("p",null,"Like so:"),(0,a.kt)("p",null,'{% code title="docker-compose.yml" %}'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'services:\n  db:\n    image: postgres:12\n    restart: always\n    volumes:\n      - /var/lib/postgresql/data\n    environment:\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: postgres\n  indexer:\n    image: subsquid/hydra-evm-indexer:5\n    restart: unless-stopped\n    environment:\n      - WORKERS_NUMBER=5\n      - DB_NAME=indexer\n      - DB_HOST=db\n      - DB_USER=postgres\n      - DB_PASS=postgres\n      - DB_PORT=5432\n      - REDIS_URI=redis://redis:6379/0\n      - BLOCK_HEIGHT=0 # starting block height\n      - FORCE_HEIGHT=true\n      - WS_PROVIDER_ENDPOINT_URI= # chain WSS\n    depends_on:\n      - db\n      - redis\n    command: >\n      sh -c "yarn db:bootstrap && yarn start:prod"\n    ports:\n      - 9090:9090\n  indexer-gateway:\n    image: subsquid/hydra-evm-indexer-gateway:5\n    restart: unless-stopped\n    depends_on:\n      - redis\n      - db\n      - indexer-status-service\n      - indexer\n    ports:\n      - "4010:8080"\n    environment:\n      - DEV_MODE=true\n      - DB_NAME=indexer\n      - DB_HOST=db\n      - DB_USER=postgres\n      - DB_PASS=postgres\n      - DB_PORT=5432\n      - HYDRA_INDEXER_STATUS_SERVICE=http://indexer-status-service:8081/status\n  indexer-status-service:\n    image: subsquid/hydra-indexer-status-service:5\n    restart: unless-stopped\n    depends_on:\n      - redis\n    environment:\n      REDIS_URI: redis://redis:6379/0\n      PORT: 8081\n  redis:\n    image: redis:6.0-alpine\n    restart: always\n    ports:\n      - "6379"\n')),(0,a.kt)("p",null,"{% endcode %}"))}h.isMDXComponent=!0},82782:function(e,t,n){t.Z=n.p+"assets/images/archive-docker-compose-up-be38dd52198fb8fb03eb61d206eb5ae3.png"},54552:function(e,t,n){t.Z=n.p+"assets/images/archive-list-b0d7c0ef04d1530af5247604e8bf38a2.png"},26550:function(e,t,n){t.Z=n.p+"assets/images/subsquid-archive-docker-container-ls-66bffe928bd0310b4946e53a84cc4ce9.png"}}]);