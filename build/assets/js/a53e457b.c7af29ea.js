"use strict";(self.webpackChunksubsquid_docs=self.webpackChunksubsquid_docs||[]).push([[4824],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=l(n),m=r,h=u["".concat(c,".").concat(m)]||u[m]||d[m]||o;return n?a.createElement(h,s(s({ref:t},p),{},{components:n})):a.createElement(h,s({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=u;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var l=2;l<o;l++)s[l]=n[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2636:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return c},default:function(){return m},frontMatter:function(){return i},metadata:function(){return l},toc:function(){return d}});var a=n(87462),r=n(63366),o=(n(67294),n(3905)),s=["components"],i={description:"The SubstrateProcessor is the main actor in transforming and loading on-chain data, according to pre-defined database model"},c="Processor",l={unversionedId:"key-concepts/processor",id:"key-concepts/processor",title:"Processor",description:"The SubstrateProcessor is the main actor in transforming and loading on-chain data, according to pre-defined database model",source:"@site/docs/key-concepts/processor.md",sourceDirName:"key-concepts",slug:"/key-concepts/processor",permalink:"/docs/key-concepts/processor",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/key-concepts/processor.md",tags:[],version:"current",frontMatter:{description:"The SubstrateProcessor is the main actor in transforming and loading on-chain data, according to pre-defined database model"},sidebar:"tutorialSidebar",previous:{title:"Architecture",permalink:"/docs/key-concepts/architecture"},next:{title:"Substrate",permalink:"/docs/key-concepts/substrate"}},p={},d=[{value:"Overview",id:"overview",level:2},{value:"Entities and Schema definition",id:"entities-and-schema-definition",level:2},{value:"Processor customization",id:"processor-customization",level:2}],u={toc:d};function m(e){var t=e.components,n=(0,r.Z)(e,s);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"processor"},"Processor"),(0,o.kt)("h2",{id:"overview"},"Overview"),(0,o.kt)("p",null,"In the ",(0,o.kt)("a",{parentName:"p",href:"/docs/key-concepts/architecture"},"Architecture")," explanation, the relationship between the Squid Archive and Squid query node was clarified. It has also been mentioned that raw chain data is decoded to be readily available for consumption."),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"/docs/key-concepts/substrate"},"Substrate")," section explained what decoded data is, what it consists of, and what information it brings."),(0,o.kt)("p",null,"Next, the ",(0,o.kt)("a",{parentName:"p",href:"/docs/key-concepts/typegen"},"Typegen")," section explained how automated tools provide a way to conveniently wrap these entities with TypeScript objects."),(0,o.kt)("p",null,"The real Squid developer experience starts with defining one's own data schema, modeling Entities that you want to keep tabs on, and tracking how on-chain information affects them."),(0,o.kt)("h2",{id:"entities-and-schema-definition"},"Entities and Schema definition"),(0,o.kt)("p",null,"The definition of a schema, and specifically knowing what Entities to identify in it, requires a level of domain knowledge that is beyond the scope of this page. Refer to the related ",(0,o.kt)("a",{parentName:"p",href:"/docs/recipes/running-a-squid/define-a-squid-schema"},"Recipe "),"for operational guidance, but in this context, we will take the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid-template"},"Squid template")," as an example."),(0,o.kt)("p",null,"In the template, the ",(0,o.kt)("inlineCode",{parentName:"p"},"Account")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"HistoricalBalance")," have been defined in the ",(0,o.kt)("inlineCode",{parentName:"p"},"schema.graphql,")," and two TypeScript models have been automatically generated for them. These can be found in two files in ",(0,o.kt)("inlineCode",{parentName:"p"},"src/model/generated/"),"."),(0,o.kt)("p",null,"Although not central to the description of the Processor, this is important because these Entities are the ones being impacted by the code defined in the Processor itself. Most importantly, these Entities will be saved and persisted in the database and made available to API clients, via the GraphQL server."),(0,o.kt)("h2",{id:"processor-customization"},"Processor customization"),(0,o.kt)("p",null,"The Processor customization starts with the ",(0,o.kt)("inlineCode",{parentName:"p"},"processor.ts")," file, this is where a ",(0,o.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," is instantiated and configured."),(0,o.kt)("p",null,"It's worth noting that the ",(0,o.kt)("inlineCode",{parentName:"p"},"Account")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"HistoricalBalance")," classes mentioned in the previous section are imported at the top of the file."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import * as ss58 from \"@subsquid/ss58\"\nimport {EventHandlerContext, Store, SubstrateProcessor} from \"@subsquid/substrate-processor\"\nimport {Account, HistoricalBalance} from \"./model\"\nimport {BalancesTransferEvent} from \"./types/events\"\n\n\nconst processor = new SubstrateProcessor('kusama_balances')\n\n\nprocessor.setTypesBundle('kusama')\nprocessor.setBatchSize(500)\n\n\nprocessor.setDataSource({\n    archive: 'https://kusama.indexer.gc.subsquid.io/v4/graphql',\n    chain: 'wss://kusama-rpc.polkadot.io'\n})\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," class accomplishes a few tasks:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"setup and start a monitoring system"),(0,o.kt)("li",{parentName:"ul"},"connect to the database (using environment variables for connection info)"),(0,o.kt)("li",{parentName:"ul"},"start a loop that processes all incoming blocks from the data source in batches",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"upon processing a batch, for each block, all relevant hooks, event handlers, and extrinsic handlers are triggered")))),(0,o.kt)("p",null,"What's more, the class exposes various methods to attach custom functions as pre and post-block hooks (these can be compared to how middleware process requests in a webserver), event handlers, and extrinsic handlers, which, as mentioned, are going to be triggered, when necessary. Here's an example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"processor.addEventHandler('balances.Transfer', async ctx => {\n    let transfer = getTransferEvent(ctx)\n    let tip = ctx.extrinsic?.tip || 0n\n    let from = ss58.codec('kusama').encode(transfer.from)\n    let to = ss58.codec('kusama').encode(transfer.to)\n\n    let fromAcc = await getOrCreate(ctx.store, Account, from)\n    fromAcc.balance = fromAcc.balance || 0n\n    fromAcc.balance -= transfer.amount\n    fromAcc.balance -= tip\n    await ctx.store.save(fromAcc)\n\n    const toAcc = await getOrCreate(ctx.store, Account, to)\n    toAcc.balance = toAcc.balance || 0n\n    toAcc.balance += transfer.amount\n    await ctx.store.save(toAcc)\n\n    await ctx.store.save(new HistoricalBalance({\n        id: ctx.event.id + '-to',\n        account: fromAcc,\n        balance: fromAcc.balance,\n        date: new Date(ctx.block.timestamp)\n    }))\n\n    await ctx.store.save(new HistoricalBalance({\n        id: ctx.event.id + '-from',\n        account: toAcc,\n        balance: toAcc.balance,\n        date: new Date(ctx.block.timestamp)\n    }))\n})\n\n\nprocessor.run()\n\n\ninterface TransferEvent {\n    from: Uint8Array\n    to: Uint8Array\n    amount: bigint\n}\n\n\nfunction getTransferEvent(ctx: EventHandlerContext): TransferEvent {\n    let event = new BalancesTransferEvent(ctx)\n    if (event.isV1020) {\n        let [from, to, amount] = event.asV1020\n        return {from, to, amount}\n    } else if (event.isV1050) {\n        let [from, to, amount] = event.asV1050\n        return {from, to, amount}\n    } else {\n        return event.asLatest\n    }\n}\n")),(0,o.kt)("p",null,"This code attaches an asynchronous function to the processor, that, similarly to a pub-sub system, gets triggered when the ",(0,o.kt)("inlineCode",{parentName:"p"},"'balances.Transfer'")," event is encountered."),(0,o.kt)("p",null,"The business logic itself is not relevant for the scope of this page, what's worth noting is that ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx")," is the ",(0,o.kt)("inlineCode",{parentName:"p"},"BlockHandlerContext"),", which stores not only information about the block itself, but the ",(0,o.kt)("inlineCode",{parentName:"p"},"Store"),", which in this case is the database, so when the following line is executed, the ",(0,o.kt)("inlineCode",{parentName:"p"},"Account")," Entity is created or updated with the relevant information."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"    await ctx.store.save(fromAcc)\n")),(0,o.kt)("p",null,"The logic in the ",(0,o.kt)("inlineCode",{parentName:"p"},"getTransferEvent")," and how it is tied to the ",(0,o.kt)("inlineCode",{parentName:"p"},"BalancesTransferEvent")," wrapper for an event has been described in ",(0,o.kt)("a",{parentName:"p",href:"/docs/key-concepts/typegen"},"the previous section")," but has been reported here because the added context might further clarify it."))}m.isMDXComponent=!0}}]);