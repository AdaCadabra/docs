"use strict";(self.webpackChunksubsquid_docs=self.webpackChunksubsquid_docs||[]).push([[3065],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=c(n),h=a,m=d["".concat(l,".").concat(h)]||d[h]||p[h]||s;return n?r.createElement(m,o(o({ref:t},u),{},{components:n})):r.createElement(m,o({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,o=new Array(s);o[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:a,o[1]=i;for(var c=2;c<s;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},13524:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return i},metadata:function(){return c},toc:function(){return p}});var r=n(87462),a=n(63366),s=(n(67294),n(3905)),o=["components"],i={},l="Substrate Processor",c={unversionedId:"reference/substrate-processor",id:"reference/substrate-processor",title:"Substrate Processor",description:"The main explanation and overview for the Processor component of a Squid has been treated in the Key Concepts section. This page will go over the most important customizations a developer would want to make, when building their API.",source:"@site/docs/reference/substrate-processor.md",sourceDirName:"reference",slug:"/reference/substrate-processor",permalink:"/docs/reference/substrate-processor",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/reference/substrate-processor.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Store interface",permalink:"/docs/reference/store-interface"},next:{title:"Tutorial",permalink:"/docs/tutorial/"}},u={},p=[{value:"Importing and instantiating",id:"importing-and-instantiating",level:2},{value:"Setting data sources",id:"setting-data-sources",level:2},{value:"Batch sizes",id:"batch-sizes",level:2},{value:"Start block/Global execution range",id:"start-blockglobal-execution-range",level:2},{value:"Types Bundle",id:"types-bundle",level:2}],d={toc:p};function h(e){var t=e.components,n=(0,a.Z)(e,o);return(0,s.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"substrate-processor"},"Substrate Processor"),(0,s.kt)("p",null,"The main explanation and overview for the Processor component of a Squid has been treated in the ",(0,s.kt)("a",{parentName:"p",href:"/docs/key-concepts/processor"},"Key Concepts")," section. This page will go over the most important customizations a developer would want to make, when building their API."),(0,s.kt)("h2",{id:"importing-and-instantiating"},"Importing and instantiating"),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"Substrate Processor")," is defined in an ",(0,s.kt)("inlineCode",{parentName:"p"},"npm")," package that needs to be installed before being able to use it:"),(0,s.kt)("p",null,'{% hint style="info" %}\nNote: the ',(0,s.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid-template"},"subsquid-template")," already has this package in its dependencies\n{% endhint %}"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm install @subsquid/substrate-processor\n")),(0,s.kt)("p",null,"Then the ",(0,s.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," class can be imported from the package"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},'import {SubstrateProcessor} from "@subsquid/substrate-processor"\n')),(0,s.kt)("p",null,"Then, it's finally possible to declare an instance of it:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"const processor = new SubstrateProcessor('kusama_balances')\n")),(0,s.kt)("p",null,'{% hint style="info" %}\nNote: all of the code snippets in this page can be found in the ',(0,s.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid-template/blob/main/src/processor.ts"},(0,s.kt)("inlineCode",{parentName:"a"},"processor.ts"))," file in the subsquid-template project\n{% endhint %}"),(0,s.kt)("h2",{id:"setting-data-sources"},"Setting data sources"),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," class exposes a method to customize its data source, by specifying a blockchain RPC WebSocked URL and an Archive endpoint URL:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"processor.setDataSource({\n    archive: 'https://kusama.indexer.gc.subsquid.io/v4/graphql',\n    chain: 'wss://kusama-rpc.polkadot.io'\n})\n")),(0,s.kt)("p",null,"The argument of the function is an interface defined in the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid/blob/master/substrate-processor/src/processor.ts#L34"},"processor's source"),", intuitively called ",(0,s.kt)("inlineCode",{parentName:"p"},"DataSource"),":"),(0,s.kt)("p",null,'{% code title="processor.ts" %}'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"export interface DataSource {\n    /**\n     * Archive endpoint URL\n     */\n    archive: string\n    /**\n     * Chain node RPC websocket URL\n     */\n    chain: string\n}\n\n// ...\n\nexport class SubstrateProcessor {\n\n    // ...\n    setDataSource(src: DataSource): void {\n        this.assertNotRunning()\n        this.src = src\n    }\n}\n")),(0,s.kt)("p",null,"{% endcode %}"),(0,s.kt)("h2",{id:"batch-sizes"},"Batch sizes"),(0,s.kt)("p",null,"Subsquids leaves to the developer the choice to set the amount of blocks to process in a single batch, which can be tweaked for performance reasons, for example."),(0,s.kt)("p",null,"Similarly to setting a data source, the ",(0,s.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," exposes a method for this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"processor.setBatchSize(500)\n")),(0,s.kt)("p",null,"Easily enough, the function is defined to accept a number as an argument:"),(0,s.kt)("p",null,'{% code title="processor.ts" %}'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"export class SubstrateProcessor {\n\n    // ...\n    setBatchSize(size: number): void {\n        this.assertNotRunning()\n        assert(size > 0)\n        this.batchSize = size\n    }\n}\n")),(0,s.kt)("p",null,"{% endcode %}"),(0,s.kt)("h2",{id:"start-blockglobal-execution-range"},"Start block/Global execution range"),(0,s.kt)("p",null,"Subsquid also gives developers the power to reduce the scope of their blockchain exploration, if they want to. It is in fact possible to configure the ",(0,s.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," to handle a range of block. The starting block is mandatory, when invoking this method, but the end block can be omitted, which means the Squid will continue to process new blocks as they are written to the blockchain."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"processor.setBlockRange({from: 583000});\n")),(0,s.kt)("p",null,"The argument of the function is an interface, defined in the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid/blob/master/substrate-processor/src/util/range.ts#L4"},"processor's source code"),", and once again intuitively called ",(0,s.kt)("inlineCode",{parentName:"p"},"Range"),"."),(0,s.kt)("p",null,'{% code title="range.ts" %}'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"export interface Range {\n    /**\n     * Start of segment (inclusive)\n     */\n    from: number\n    /**\n     * End of segment (inclusive). Defaults to infinity.\n     */\n    to?: number\n}\n")),(0,s.kt)("p",null,"{% endcode %}"),(0,s.kt)("p",null,"And used in the function definition."),(0,s.kt)("p",null,'{% code title="processor.ts" %}'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"export class SubstrateProcessor {\n\n    // ...\n    setBlockRange(range: Range): void {\n        this.assertNotRunning()\n        this.blockRange = range\n    }\n}\n")),(0,s.kt)("p",null,"{% endcode %}"),(0,s.kt)("h2",{id:"types-bundle"},"Types Bundle"),(0,s.kt)("p",null,"It is mandatory for the Processor correct execution to specify the types Bundle it needs to take into account. I can be done this way:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"processor.setTypesBundle('kusama');\n")),(0,s.kt)("p",null,"The function parameter can either be"," "),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"the name of a blockchain, for ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/subsquid/squid/tree/master/substrate-metadata/src/old/definitions"},"which Subsquid has built-in typesBundle")),(0,s.kt)("li",{parentName:"ul"},"the path to a JSON file containing the definitions"),(0,s.kt)("li",{parentName:"ul"},"an object, containing the definitions, respecting the typing of the ",(0,s.kt)("inlineCode",{parentName:"li"},"OldTypesBundle")," interface")),(0,s.kt)("p",null,"Here is how it's defined in the ",(0,s.kt)("inlineCode",{parentName:"p"},"SubstrateProcessor")," class:"),(0,s.kt)("p",null,'{% code title="processor.ts" %}'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"export class SubstrateProcessor {\n\n    // ...\n    setTypesBundle(bundle: string | OldTypesBundle): void {\n        this.assertNotRunning()\n        if (typeof bundle == 'string') {\n            this.typesBundle = getOldTypesBundle(bundle) || readOldTypesBundle(bundle)\n        } else {\n            this.typesBundle = bundle\n        }\n    }\n}\n")),(0,s.kt)("p",null,"{% endcode %}"),(0,s.kt)("p",null,"Where the two ",(0,s.kt)("inlineCode",{parentName:"p"},"getOldTypesBundle")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"readOldTypesBundle"),"  functions are defined as such:"),(0,s.kt)("p",null,'{% code title="io.ts" %}'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"export function getOldTypesBundle(chain: string): OldTypesBundle | undefined {\n    switch(chain) {\n        // ...\n        case 'kusama':\n            return require('./old/definitions/kusama').bundle\n        // ...\n        case 'polkadot':\n            return require('./old/definitions/polkadot').bundle\n        default:\n            return undefined\n    }\n}\n\n\nexport function readOldTypesBundle(file: string): OldTypesBundle {\n    let content: string\n    try {\n        content = fs.readFileSync(file, 'utf-8')\n    } catch(e: any) {\n        throw new OldTypesBundleError(`Failed to read ${file}: ${e}`)\n    }\n    let json: any\n    try {\n        json = JSON.parse(content)\n    } catch(e: any) {\n        throw new OldTypesBundleError(`Failed to parse ${file}: ${e}`)\n    }\n    return json\n}\n")),(0,s.kt)("p",null,"{% endcode %}"),(0,s.kt)("p",null,"Which, respectively, collect a built-in typesBundle from the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/subsquid/squid/tree/master/substrate-metadata/src/old/definitions"},"available list"),", or process a JSON file, given its path."))}h.isMDXComponent=!0}}]);